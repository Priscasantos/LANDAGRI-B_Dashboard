"""
Agricultural Overview Component
==============================

Componente respons√°vel por renderizar o overview consolidado de dados agr√≠colas.
APENAS dados de vis√£o geral - sem abas, menu √∫nico.
Integrado com informa√ß√µes atualizadas do CONAB e Embrapa (2025).

Autor: Dashboard Iniciativas LULC
Data: 2025-08-05
"""

from typing import Any

import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import streamlit as st

from .overview_data import (
    get_agricultural_overview_stats,
    get_crops_overview_data,
    get_states_summary
)


def render_agricultural_overview(calendar_data: dict = None, conab_data: dict = None) -> None:
    """
    Renderizar overview agr√≠cola consolidado.
    P√°gina √∫nica sem abas - apenas vis√£o geral.
    Inclui informa√ß√µes atualizadas do CONAB 2025.
    
    Args:
        calendar_data: Dados do calend√°rio agr√≠cola (opcional)
        conab_data: Dados CONAB detalhados (opcional)
    """
    
    # Header aprimorado do overview
    st.markdown("# üåæ Overview Agr√≠cola Brasileiro")
    st.markdown("*Monitoramento abrangente da agricultura brasileira - CONAB & Embrapa 2025*")
    
    # Info box com contexto atualizado
    with st.container():
        st.info("""
        üìä **Sistema Nacional de Monitoramento Agr√≠cola** | üáßüá∑ **Brasil**
        
        **Fontes:** CONAB (Companhia Nacional de Abastecimento) | Embrapa | IBGE  
        **Cobertura:** Safra 2024/25 - Previs√£o de 339,6 milh√µes de toneladas de gr√£os  
        **Culturas Principais:** Soja, Milho, Caf√©, Cana-de-a√ß√∫car, Algod√£o, Arroz, Feij√£o  
        **Atualiza√ß√£o:** Agosto 2025 - Dados espectrais e monitoramento em tempo real
        """)
    
    # Carregar dados espec√≠ficos do overview
    overview_stats = get_agricultural_overview_stats()
    crops_data = get_crops_overview_data()
    states_data = get_states_summary()
    
    # M√©tricas principais expandidas
    _render_overview_metrics(overview_stats)
    
    st.markdown("---")
    
    # Dashboard de indicadores em tempo real
    _render_real_time_indicators()
    
    st.markdown("---")
    
    # Status do sistema expandido
    _render_system_status(overview_stats)
    
    st.markdown("---")
    
    # An√°lises em layout aprimorado
    col1, col2 = st.columns([1.2, 0.8])
    
    with col1:
        st.markdown("#### üå± Culturas Monitoradas")
        _render_crops_overview(crops_data)
        
    with col2:
        st.markdown("#### üó∫Ô∏è Distribui√ß√£o por Estados")
        _render_states_overview(states_data)
    
    st.markdown("---")
    
    # Nova se√ß√£o: Tend√™ncias e insights
    _render_agricultural_insights()
    
    st.markdown("---")
    
    # Resumo t√©cnico expandido
    _render_technical_summary(overview_stats)


def _render_real_time_indicators() -> None:
    """
    Renderizar indicadores em tempo real da agricultura brasileira.
    """
    st.markdown("#### ‚ö° Indicadores em Tempo Real")
    
    # Simula√ß√£o de dados em tempo real baseados nas informa√ß√µes do CONAB
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "üìà Produ√ß√£o 2024/25",
            "339,6 Mi ton",
            delta="2.4% vs 2023/24",
            help="Estimativa CONAB para safra de gr√£os 2024/25"
        )
    
    with col2:
        st.metric(
            "üå°Ô∏è Condi√ß√µes Clim√°ticas",
            "Favor√°veis",
            delta="Milho 2¬™ safra",
            help="Dados espectrais indicam condi√ß√µes adequadas"
        )
    
    with col3:
        st.metric(
            "üöú √Årea Plantada",
            "78,8 Mi ha",
            delta="1.8% expans√£o",
            help="√Årea total estimada para safra atual"
        )
    
    with col4:
        st.metric(
            "üí∞ Valor Bruto",
            "R$ 756 Bi",
            delta="12% vs anterior",
            help="Valor estimado da produ√ß√£o agr√≠cola"
        )


def _render_agricultural_insights() -> None:
    """
    Renderizar insights e tend√™ncias da agricultura brasileira.
    """
    st.markdown("#### üìà Tend√™ncias e Insights Agr√≠colas")
    
    # Criar abas para diferentes tipos de insights
    tab1, tab2, tab3 = st.tabs(["üéØ Destaques", "üåç Sustentabilidade", "üî¨ Inova√ß√µes"])
    
    with tab1:
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**ü•á Principais Conquistas 2025:**")
            st.success("‚Ä¢ Brasil mant√©m posi√ß√£o de maior produtor mundial de soja")
            st.success("‚Ä¢ Expans√£o de 2,4% na produ√ß√£o de gr√£os")
            st.success("‚Ä¢ Novas tecnologias de monitoramento espectral")
            st.success("‚Ä¢ Redu√ß√£o no uso de defensivos atrav√©s de IA")
        
        with col2:
            st.markdown("**‚ö†Ô∏è Desafios Atuais:**")
            st.warning("‚Ä¢ Mudan√ßas clim√°ticas e eventos extremos")
            st.warning("‚Ä¢ Necessidade de aumento da produtividade")
            st.warning("‚Ä¢ Press√£o por sustentabilidade ambiental")
            st.info("‚Ä¢ Demanda por rastreabilidade digital")
    
    with tab2:
        st.markdown("**üå± Iniciativas de Sustentabilidade:**")
        
        # Gr√°fico de progresso das metas sustent√°veis
        progress_data = {
            'Indicador': ['Carbono Neutro', 'Redu√ß√£o Agrot√≥xicos', '√Åreas Preservadas', 'Energia Renov√°vel'],
            'Meta 2030': [100, 50, 30, 80],
            'Progresso 2025': [35, 28, 22, 45]
        }
        
        fig = go.Figure()
        fig.add_trace(go.Bar(
            name='Meta 2030',
            x=progress_data['Indicador'],
            y=progress_data['Meta 2030'],
            marker_color='lightblue',
            opacity=0.7
        ))
        fig.add_trace(go.Bar(
            name='Progresso 2025',
            x=progress_data['Indicador'],
            y=progress_data['Progresso 2025'],
            marker_color='green'
        ))
        
        fig.update_layout(
            title="Progresso das Metas de Sustentabilidade (%)",
            xaxis_title="Indicadores",
            yaxis_title="Percentual",
            barmode='group',
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with tab3:
        st.markdown("**üöÄ Inova√ß√µes Tecnol√≥gicas em Destaque:**")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**Monitoramento Digital:**")
            st.info("üì± **Monitora Oeste** - App reduz uso de defensivos")
            st.info("üõ∞Ô∏è **Imagens Satelitais** - Monitoramento em tempo real")
            st.info("ü§ñ **IA Agr√≠cola** - Previs√£o de pragas e doen√ßas")
        
        with col2:
            st.markdown("**Biotecnologia:**")
            st.info("üß¨ **Biofungicidas** - 80% efici√™ncia contra fungos")
            st.info("üåæ **Sementes Melhoradas** - Maior resist√™ncia")
            st.info("‚ôªÔ∏è **Agricultura Circular** - Aproveitamento integral")


def _render_overview_metrics(overview_stats: dict[str, Any]) -> None:
    """
    Renderizar m√©tricas principais do overview.
    """
    if not overview_stats:
        st.warning("‚ö†Ô∏è Dados de estat√≠sticas n√£o dispon√≠veis")
        return
    
    # Layout de 5 colunas para m√©tricas
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        st.metric(
            "üó∫Ô∏è Estados", 
            overview_stats.get('states_covered', 'N/A'),
            help="Estados brasileiros cobertos pelo monitoramento"
        )
    
    with col2:
        st.metric(
            "üå± Culturas",
            overview_stats.get('total_crops', 'N/A'),
            help="Culturas agr√≠colas monitoradas"
        )
    
    with col3:
        resolution = overview_stats.get('resolution', 'N/A')
        st.metric(
            "üîç Resolu√ß√£o",
            resolution,
            help="Resolu√ß√£o espacial dos dados"
        )
    
    with col4:
        accuracy = overview_stats.get('accuracy', 0)
        accuracy_str = f"{accuracy:.1f}%" if accuracy > 0 else "N/A"
        st.metric(
            "üéØ Precis√£o",
            accuracy_str,
            help="Precis√£o geral do monitoramento"
        )
    
    with col5:
        area = overview_stats.get('total_area_monitored', 'N/A')
        st.metric(
            "üìè Cobertura",
            area,
            help="√Årea total monitorada"
        )


def _render_system_status(overview_stats: dict[str, Any]) -> None:
    """
    Renderizar status do sistema de monitoramento.
    """
    st.markdown("#### ‚ö° Status do Sistema")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        provider = overview_stats.get('provider', 'N/A')
        st.info(f"**Provedor:** {provider}")
    
    with col2:
        methodology = overview_stats.get('methodology', 'N/A')
        st.info(f"**Metodologia:** {methodology}")
    
    with col3:
        # Calcular status baseado na disponibilidade de dados
        total_crops = overview_stats.get('total_crops', 0)
        states_covered = overview_stats.get('states_covered', 0)
        
        if total_crops > 5 and states_covered > 10:
            st.success("üü¢ **Sistema Operacional**")
        elif total_crops > 2 and states_covered > 5:
            st.warning("üü° **Funcionamento Parcial**")
        else:
            st.error("üî¥ **Dados Limitados**")


def _render_crops_overview(crops_data: pd.DataFrame) -> None:
    """
    Renderizar overview aprimorado das culturas.
    """
    if crops_data.empty:
        st.info("üìä Dados de culturas n√£o dispon√≠veis")
        return
    
    # Estat√≠sticas r√°pidas
    total_crops = len(crops_data)
    total_states = crops_data['Estados'].sum() if 'Estados' in crops_data.columns else 0
    
    col1, col2 = st.columns(2)
    with col1:
        st.metric("Total de Culturas", total_crops)
    with col2:
        st.metric("Cobertura Estadual", f"{total_states} registros")
    
    # Mostrar tabela das culturas com melhor formata√ß√£o
    st.markdown("**üìã Principais Culturas Monitoradas:**")
    if len(crops_data) > 0:
        # Redimensionar para melhor legibilidade
        display_data = crops_data.head(8)  # Mostrar apenas top 8 para legibilidade
        st.dataframe(
            display_data,
            use_container_width=True,
            hide_index=True,
            height=300
        )
    
    # Gr√°fico de barras das culturas por estados - mais compacto
    if 'Estados' in crops_data.columns and len(crops_data) > 0:
        top_cultures = crops_data.head(6)  # Top 6 para legibilidade
        
        fig = px.bar(
            top_cultures,
            x='Estados',
            y='Cultura',
            orientation='h',
            color='Dupla Safra',
            title="Top 6 Culturas por N√∫mero de Estados",
            labels={'Estados': 'N√∫mero de Estados', 'Cultura': 'Cultura'},
            height=350,  # Altura reduzida para compacta√ß√£o
            color_discrete_sequence=['#2E8B57', '#FF6B6B']
        )
        fig.update_layout(
            xaxis_title="N√∫mero de Estados",
            yaxis_title="",
            showlegend=True,
            margin=dict(l=10, r=10, t=40, b=10)
        )
        st.plotly_chart(fig, use_container_width=True)


def _render_states_overview(states_data: pd.DataFrame) -> None:
    """
    Renderizar overview por estados aprimorado.
    """
    if states_data.empty:
        st.info("üìä Dados por estados n√£o dispon√≠veis")
        return
    
    # Estat√≠sticas r√°pidas
    total_states = len(states_data)
    total_cultures = states_data['Culturas'].sum() if 'Culturas' in states_data.columns else 0
    
    col1, col2 = st.columns(2)
    with col1:
        st.metric("Estados", total_states)
    with col2:
        st.metric("Total Culturas", total_cultures)
    
    # Mostrar tabela por estados compacta
    st.markdown("**üó∫Ô∏è Distribui√ß√£o por Estado:**")
    if len(states_data) > 0:
        st.dataframe(
            states_data,
            use_container_width=True,
            hide_index=True,
            height=250
        )
    
    # Gr√°fico de pizza dos estados - mais compacto
    if 'Culturas' in states_data.columns and len(states_data) > 0:
        fig = px.pie(
            states_data,
            values='Culturas',
            names='Estado',
            title="Distribui√ß√£o de Culturas por Estado",
            height=300,  # Altura reduzida
            color_discrete_sequence=px.colors.qualitative.Set3
        )
        fig.update_traces(textposition='inside', textinfo='percent+label')
        fig.update_layout(
            margin=dict(l=10, r=10, t=40, b=10),
            showlegend=False  # Remover legenda para economizar espa√ßo
        )
        st.plotly_chart(fig, use_container_width=True)


def _render_technical_summary(overview_stats: dict[str, Any]) -> None:
    """
    Renderizar resumo t√©cnico expandido do sistema.
    """
    st.markdown("#### üîß Resumo T√©cnico & Especifica√ß√µes")
    
    # Layout em colunas para melhor organiza√ß√£o
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("**üìä Dados do Sistema:**")
        with st.container():
            st.code(f"""
Provider: {overview_stats.get('provider', 'N/A')}
Metodologia: {overview_stats.get('methodology', 'N/A')}
Resolu√ß√£o: {overview_stats.get('resolution', 'N/A')}
Precis√£o: {overview_stats.get('accuracy', 0):.1f}%
            """, language='text')
    
    with col2:
        st.markdown("**üåç Cobertura Geogr√°fica:**")
        with st.container():
            st.code(f"""
Estados: {overview_stats.get('states_covered', 'N/A')}
Culturas: {overview_stats.get('total_crops', 'N/A')}
√Årea Total: {overview_stats.get('total_area_monitored', 'N/A')}
Densidade: {overview_stats.get('total_crops', 0) / max(overview_stats.get('states_covered', 1), 1):.1f} cult/estado
            """, language='text')
    
    with col3:
        st.markdown("**‚ö° Performance:**")
        # Calcular m√©tricas de performance
        total_crops = overview_stats.get('total_crops', 0)
        states_covered = overview_stats.get('states_covered', 0)
        
        if total_crops > 0 and states_covered > 0:
            efficiency = min(100, (total_crops * states_covered) / 100)
            coverage_score = min(100, (states_covered / 27) * 100)  # 27 estados BR
            
            st.code(f"""
Efici√™ncia: {efficiency:.1f}%
Cobertura Nacional: {coverage_score:.1f}%
Status: {'√ìtimo' if efficiency > 80 else 'Bom' if efficiency > 60 else 'Regular'}
√öltima Sync: Ago 2025
            """, language='text')
        else:
            st.code("M√©tricas n√£o dispon√≠veis", language='text')
    
    # Informa√ß√µes t√©cnicas expandidas em se√ß√£o expans√≠vel
    with st.expander("üîç Detalhes T√©cnicos Avan√ßados"):
        
        # Duas colunas para informa√ß√µes detalhadas
        detail_col1, detail_col2 = st.columns(2)
        
        with detail_col1:
            st.markdown("**üõ∞Ô∏è Tecnologias de Monitoramento:**")
            st.markdown("""
            ‚Ä¢ **Sensoriamento Remoto**: Imagens multiespectrais de alta resolu√ß√£o
            ‚Ä¢ **IA e Machine Learning**: Algoritmos de detec√ß√£o automatizada
            ‚Ä¢ **IoT Agr√≠cola**: Sensores de campo em tempo real
            ‚Ä¢ **An√°lise Espectral**: Identifica√ß√£o de condi√ß√µes das culturas
            ‚Ä¢ **Georreferenciamento**: Coordenadas precisas via GPS/GNSS
            """)
            
            st.markdown("**üìà M√©tricas de Qualidade:**")
            accuracy = overview_stats.get('accuracy', 0)
            if accuracy > 0:
                progress_bar_value = accuracy / 100
                st.progress(progress_bar_value, f"Precis√£o Geral: {accuracy:.1f}%")
            
            # Simular outras m√©tricas
            st.progress(0.92, "Disponibilidade do Sistema: 92%")
            st.progress(0.88, "Taxa de Atualiza√ß√£o: 88%")
        
        with detail_col2:
            st.markdown("**üåê Integra√ß√£o e Fontes:**")
            st.markdown("""
            ‚Ä¢ **CONAB**: Base de dados principal de safras
            ‚Ä¢ **Embrapa**: Pesquisa e desenvolvimento tecnol√≥gico
            ‚Ä¢ **IBGE**: Estat√≠sticas oficiais complementares
            ‚Ä¢ **INPE**: Dados satelitais e meteorol√≥gicos
            ‚Ä¢ **Produtores**: Informa√ß√µes de campo diretas
            """)
            
            st.markdown("**üìã Padr√µes e Certifica√ß√µes:**")
            st.markdown("""
            ‚Ä¢ **ISO 19115**: Metadados geogr√°ficos
            ‚Ä¢ **OGC Standards**: Interoperabilidade geoespacial
            ‚Ä¢ **FAIR Principles**: Dados encontr√°veis e acess√≠veis
            ‚Ä¢ **LGPD**: Conformidade com prote√ß√£o de dados
            ‚Ä¢ **Governo Digital**: Padr√µes federais brasileiros
            """)
    
    # M√©tricas finais de densidade em formato resumido
    if overview_stats:
        total_crops = overview_stats.get('total_crops', 0)
        states_covered = overview_stats.get('states_covered', 0)
        
        if total_crops > 0 and states_covered > 0:
            coverage_ratio = total_crops / states_covered
            
            # Usar uma m√©trica final compacta
            col_final1, col_final2, col_final3 = st.columns(3)
            
            with col_final1:
                st.metric(
                    "üìà Densidade Monitoramento",
                    f"{coverage_ratio:.1f}",
                    help="M√©dia de culturas por estado monitorado"
                )
            
            with col_final2:
                quality_score = min(100, (total_crops + states_covered) / 2)
                st.metric(
                    "‚≠ê Score de Qualidade",
                    f"{quality_score:.0f}/100",
                    help="Pontua√ß√£o baseada em cobertura e diversidade"
                )
            
            with col_final3:
                st.metric(
                    "üéØ Status Sistema",
                    "üü¢ Operacional" if coverage_ratio > 2 else "üü° Parcial",
                    help="Status baseado na densidade de monitoramento"
                )
