"""
Monthly Activity Charts
======================

M√≥dulo de gr√°ficos de atividades mensais consolidados do old_calendar.
Implementa visualiza√ß√µes para an√°lise temporal de atividades agr√≠colas.

Autor: Dashboard Iniciativas LULC
Data: 2025-08-07
"""

import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import streamlit as st
from typing import Dict, List, Optional


def create_total_activities_per_month_chart(filtered_data: dict) -> Optional[go.Figure]:
    """
    Cria gr√°fico de total de atividades por m√™s.
    
    Equivalente ao: total_activities_per_month.png do old_calendar/national/
    
    Args:
        filtered_data: Dados filtrados do calend√°rio agr√≠cola
        
    Returns:
        go.Figure: Figura do Plotly ou None se n√£o h√° dados
    """
    try:
        crop_calendar = filtered_data.get('crop_calendar', {})
        
        if not crop_calendar:
            st.info("üìä Sem dados de calend√°rio dispon√≠veis para atividades mensais")
            return None

        # Inicializa contadores mensais
        months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        monthly_activities = {month: 0 for month in months}

        # Conta atividades por m√™s
        for crop, states_data in crop_calendar.items():
            for state, activities in states_data.items():
                # Conta plantio
                for month in activities.get('planting_months', []):
                    if month in monthly_activities:
                        monthly_activities[month] += 1
                
                # Conta colheita
                for month in activities.get('harvesting_months', []):
                    if month in monthly_activities:
                        monthly_activities[month] += 1

        if not any(monthly_activities.values()):
            st.info("üìä Nenhuma atividade mensal encontrada nos dados")
            return None

        # Cria DataFrame
        df = pd.DataFrame(list(monthly_activities.items()), columns=['M√™s', 'Total_Atividades'])

        # Cria gr√°fico de linhas
        fig = px.line(
            df,
            x='M√™s',
            y='Total_Atividades',
            title="üìÖ Total de Atividades Agr√≠colas por M√™s",
            labels={
                'Total_Atividades': 'N√∫mero Total de Atividades',
                'M√™s': 'M√™s do Ano'
            },
            markers=True
        )

        # Personaliza layout
        fig.update_layout(
            height=400,
            xaxis_title="M√™s do Ano",
            yaxis_title="N√∫mero Total de Atividades",
            showlegend=False
        )

        # Adiciona valores nos pontos
        fig.update_traces(
            mode='lines+markers+text',
            text=df['Total_Atividades'],
            textposition='top center'
        )

        return fig

    except Exception as e:
        st.error(f"‚ùå Erro ao criar gr√°fico de atividades mensais: {e}")
        return None


def create_planting_vs_harvesting_per_month_chart(filtered_data: dict) -> Optional[go.Figure]:
    """
    Cria gr√°fico comparativo de plantio vs colheita por m√™s.
    
    Equivalente ao: planting_vs_harvesting_per_month.png do old_calendar/national/
    
    Args:
        filtered_data: Dados filtrados do calend√°rio agr√≠cola
        
    Returns:
        go.Figure: Figura do Plotly ou None se n√£o h√° dados
    """
    try:
        crop_calendar = filtered_data.get('crop_calendar', {})
        
        if not crop_calendar:
            st.info("üìä Sem dados de calend√°rio dispon√≠veis para compara√ß√£o plantio vs colheita")
            return None

        # Inicializa contadores mensais
        months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        planting_counts = {month: 0 for month in months}
        harvesting_counts = {month: 0 for month in months}

        # Conta atividades por m√™s
        for crop, states_data in crop_calendar.items():
            for state, activities in states_data.items():
                # Conta plantio
                for month in activities.get('planting_months', []):
                    if month in planting_counts:
                        planting_counts[month] += 1
                
                # Conta colheita
                for month in activities.get('harvesting_months', []):
                    if month in harvesting_counts:
                        harvesting_counts[month] += 1

        # Cria DataFrame
        df = pd.DataFrame({
            'M√™s': months,
            'Plantio': [planting_counts[month] for month in months],
            'Colheita': [harvesting_counts[month] for month in months]
        })

        # Cria gr√°fico de barras agrupadas
        fig = go.Figure()

        fig.add_trace(go.Bar(
            name='üå± Plantio',
            x=df['M√™s'],
            y=df['Plantio'],
            marker_color='lightgreen',
            text=df['Plantio'],
            textposition='outside'
        ))

        fig.add_trace(go.Bar(
            name='üåæ Colheita',
            x=df['M√™s'],
            y=df['Colheita'],
            marker_color='orange',
            text=df['Colheita'],
            textposition='outside'
        ))

        # Personaliza layout
        fig.update_layout(
            title="üå±üìÖ Compara√ß√£o Plantio vs Colheita por M√™s",
            xaxis_title="M√™s do Ano",
            yaxis_title="N√∫mero de Atividades",
            barmode='group',
            height=500,
            legend=dict(
                orientation="h",
                yanchor="bottom",
                y=1.02,
                xanchor="right",
                x=1
            )
        )

        return fig

    except Exception as e:
        st.error(f"‚ùå Erro ao criar gr√°fico plantio vs colheita: {e}")
        return None


def create_simultaneous_planting_harvesting_chart(filtered_data: dict) -> Optional[go.Figure]:
    """
    Cria gr√°fico de atividades simult√¢neas de plantio e colheita.
    
    Equivalente ao: simultaneous_planting_harvesting.png do old_calendar/national/
    
    Args:
        filtered_data: Dados filtrados do calend√°rio agr√≠cola
        
    Returns:
        go.Figure: Figura do Plotly ou None se n√£o h√° dados
    """
    try:
        crop_calendar = filtered_data.get('crop_calendar', {})
        
        if not crop_calendar:
            st.info("üìä Sem dados de calend√°rio dispon√≠veis para atividades simult√¢neas")
            return None

        # Inicializa contadores mensais
        months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        simultaneous_activities = {month: 0 for month in months}

        # Identifica atividades simult√¢neas por m√™s
        for crop, states_data in crop_calendar.items():
            for state, activities in states_data.items():
                planting_months = set(activities.get('planting_months', []))
                harvesting_months = set(activities.get('harvesting_months', []))
                
                # Encontra meses com atividades simult√¢neas
                simultaneous_months = planting_months.intersection(harvesting_months)
                
                for month in simultaneous_months:
                    if month in simultaneous_activities:
                        simultaneous_activities[month] += 1

        if not any(simultaneous_activities.values()):
            st.info("üìä Nenhuma atividade simult√¢nea encontrada nos dados")
            return None

        # Cria DataFrame
        df = pd.DataFrame(list(simultaneous_activities.items()), columns=['M√™s', 'Atividades_Simult√¢neas'])

        # Cria gr√°fico de barras
        fig = px.bar(
            df,
            x='M√™s',
            y='Atividades_Simult√¢neas',
            title="üîÑ Atividades Simult√¢neas de Plantio e Colheita por M√™s",
            labels={
                'Atividades_Simult√¢neas': 'N√∫mero de Atividades Simult√¢neas',
                'M√™s': 'M√™s do Ano'
            },
            color='Atividades_Simult√¢neas',
            color_continuous_scale='Reds'
        )

        # Personaliza layout
        fig.update_layout(
            height=400,
            xaxis_title="M√™s do Ano",
            yaxis_title="N√∫mero de Atividades Simult√¢neas",
            showlegend=False,
            coloraxis_showscale=False
        )

        # Adiciona valores nas barras
        fig.update_traces(
            texttemplate='%{y}',
            textposition='outside'
        )

        return fig

    except Exception as e:
        st.error(f"‚ùå Erro ao criar gr√°fico de atividades simult√¢neas: {e}")
        return None


def create_planting_harvesting_periods_chart(filtered_data: dict) -> Optional[go.Figure]:
    """
    Cria gr√°fico de per√≠odos de plantio e colheita.
    
    Equivalente ao: planting_harvesting_periods.png do old_calendar/national/
    
    Args:
        filtered_data: Dados filtrados do calend√°rio agr√≠cola
        
    Returns:
        go.Figure: Figura do Plotly ou None se n√£o h√° dados
    """
    try:
        crop_calendar = filtered_data.get('crop_calendar', {})
        
        if not crop_calendar:
            st.info("üìä Sem dados de calend√°rio dispon√≠veis para per√≠odos de plantio e colheita")
            return None

        # Prepara dados para heatmap de per√≠odos
        months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        
        heatmap_data = []
        
        for crop, states_data in crop_calendar.items():
            crop_row_planting = []
            crop_row_harvesting = []
            
            for month in months:
                # Conta estados com plantio neste m√™s
                planting_count = 0
                harvesting_count = 0
                
                for state, activities in states_data.items():
                    if month in activities.get('planting_months', []):
                        planting_count += 1
                    if month in activities.get('harvesting_months', []):
                        harvesting_count += 1
                
                crop_row_planting.append(planting_count)
                crop_row_harvesting.append(harvesting_count)
            
            # Adiciona dados ao heatmap
            heatmap_data.append({
                'Cultura': f"{crop} (Plantio)",
                'Tipo': 'Plantio',
                **{months[i]: crop_row_planting[i] for i in range(len(months))}
            })
            
            heatmap_data.append({
                'Cultura': f"{crop} (Colheita)",
                'Tipo': 'Colheita',
                **{months[i]: crop_row_harvesting[i] for i in range(len(months))}
            })

        if not heatmap_data:
            st.info("üìä Nenhum per√≠odo encontrado nos dados")
            return None

        # Cria DataFrame
        df = pd.DataFrame(heatmap_data)
        
        # Prepara matriz para heatmap
        z_data = df[months].values
        y_labels = df['Cultura'].tolist()

        # Cria heatmap
        fig = go.Figure(data=go.Heatmap(
            z=z_data,
            x=months,
            y=y_labels,
            colorscale='RdYlGn',
            text=z_data,
            texttemplate="%{text}",
            textfont={"size": 10},
            hoverongaps=False
        ))

        # Personaliza layout
        fig.update_layout(
            title="üóìÔ∏è Per√≠odos de Plantio e Colheita por Cultura",
            xaxis_title="M√™s do Ano",
            yaxis_title="Cultura (Tipo de Atividade)",
            height=400 + (len(y_labels) * 15)
        )

        return fig

    except Exception as e:
        st.error(f"‚ùå Erro ao criar gr√°fico de per√≠odos de plantio e colheita: {e}")
        return None


def render_monthly_activity_charts(filtered_data: dict) -> None:
    """
    Renderiza todos os gr√°ficos de atividades mensais.
    
    Args:
        filtered_data: Dados filtrados do calend√°rio agr√≠cola
    """
    st.markdown("### üìÖ An√°lise de Atividades Mensais")
    
    # Primeira linha: atividades totais e compara√ß√£o plantio vs colheita
    col1, col2 = st.columns(2)
    
    with col1:
        fig1 = create_total_activities_per_month_chart(filtered_data)
        if fig1:
            st.plotly_chart(fig1, use_container_width=True)
    
    with col2:
        fig2 = create_planting_vs_harvesting_per_month_chart(filtered_data)
        if fig2:
            st.plotly_chart(fig2, use_container_width=True)
    
    # Segunda linha: atividades simult√¢neas
    col3, col4 = st.columns(2)
    
    with col3:
        fig3 = create_simultaneous_planting_harvesting_chart(filtered_data)
        if fig3:
            st.plotly_chart(fig3, use_container_width=True)
    
    with col4:
        st.info("üìä Espa√ßo reservado para m√©tricas adicionais")
    
    # Terceira linha: per√≠odos completos (largura total)
    st.markdown("#### üóìÔ∏è Per√≠odos Detalhados de Plantio e Colheita")
    fig4 = create_planting_harvesting_periods_chart(filtered_data)
    if fig4:
        st.plotly_chart(fig4, use_container_width=True)
